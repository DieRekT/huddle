<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huddle - Viewer</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="/theme.css">
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/assets/huddle_loader_particles.css">
</head>
<body>
    <!-- Viewer Screen -->
    <div id="viewerScreen" class="screen viewer-screen-dark active">
        <div class="viewer-shell">
            <!-- Fixed top bar -->
            <header class="viewer-topbar">
                <div class="topbar-left">
                    <div class="brand">
                        <svg class="huddle-mark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" fill="none" aria-hidden="true">
                            <circle cx="32" cy="32" r="2" fill="currentColor" opacity="0.9"/>
                            <circle cx="32" cy="32" r="8" stroke="currentColor" stroke-width="2" opacity="0.6"/>
                            <circle cx="32" cy="32" r="14" stroke="currentColor" stroke-width="1.5" opacity="0.4"/>
                            <circle cx="32" cy="32" r="20" stroke="currentColor" stroke-width="1" opacity="0.3"/>
                            <rect x="28" y="18" width="8" height="12" rx="4" fill="currentColor"/>
                            <path d="M 26 30 L 24 38 L 40 38 L 38 30 Z" fill="currentColor"/>
                            <path d="M 18 32 Q 22 28, 26 32 Q 30 36, 34 32" stroke="currentColor" stroke-width="2" fill="none" opacity="0.7" stroke-linecap="round"/>
                            <path d="M 38 32 Q 42 28, 46 32" stroke="currentColor" stroke-width="1.5" fill="none" opacity="0.5" stroke-linecap="round"/>
                        </svg>
                        <span class="brand-text">Huddle</span>
                    </div>
                    <div class="room-pill room-pill-dark" id="roomLivePill" title="Room code">
                        <span class="room-pill-label">Room</span>
                        <span class="room-pill-code" id="viewerRoomCode"></span>
                    </div>
                    <div class="connection-chip" id="connectionChip" title="Connection status">
                        <span class="connection-dot" id="connectionStatusDot"></span>
                        <span class="connection-text" id="connectionStatusText">Live</span>
                    </div>
                </div>
                <div class="topbar-right">
                    <label class="alerts-select" aria-label="Alerts">
                        <span class="visually-hidden">Alerts</span>
                        <select id="alertsSelect">
                            <option>Off</option>
                            <option>Gentle</option>
                            <option>Strong</option>
                        </select>
                    </label>
                    <div class="font-size-controls" role="group" aria-label="Text size">
                        <button class="btn btn-secondary btn-small" id="fontSizeDownBtn" type="button">A-</button>
                        <button class="btn btn-secondary btn-small" id="fontSizeUpBtn" type="button">A+</button>
                    </div>
                    <details class="menu settings-drawer">
                        <summary class="icon-btn" aria-label="Settings">⚙️</summary>
                        <div class="menu-panel card">
                            <div class="menu-title">Settings</div>
                            <div class="menu-section">
                                <div class="menu-section-title">Accessibility</div>
                                <button id="fontSizeToggle" class="btn btn-secondary btn-small menu-btn">Font size: Normal</button>
                                <button id="highContrastToggle" class="btn btn-secondary btn-small menu-btn">High contrast: Off</button>
                            </div>
                            <div class="menu-divider"></div>
                            <div class="menu-section">
                                <div class="menu-section-title">Actions</div>
                                <button id="btnInvite" class="btn btn-secondary btn-small menu-btn">Invite</button>
                                <button id="readRoomBtn" class="btn btn-secondary btn-small menu-btn">Read the Room</button>
                                <button id="viewerMicBtn" class="btn btn-secondary btn-small menu-btn" title="Enable microphone (then click to mute/unmute)">Enable mic</button>
                                <button id="zenModeToggle" class="btn btn-secondary btn-small menu-btn" title="Zen mode: hide transcript">Zen</button>
                                <button id="disableMicMenuBtn" class="btn btn-secondary btn-small menu-btn" style="display:none;">Disable mic</button>
                                <button id="copyMicLinkBtn" class="btn btn-secondary btn-small menu-btn">Copy mic link</button>
                                <button id="copyCodeBtn" class="btn btn-secondary btn-small menu-btn">Copy room code</button>
                                <button id="saveClearBtn" class="btn btn-secondary btn-small menu-btn" title="Save a concise session snapshot, then clear the room for a fresh start">Save &amp; Clear</button>
                                <button id="exportBtn" class="btn btn-secondary btn-small menu-btn">Export</button>
                                <button id="endSessionBtn" class="btn btn-danger btn-small menu-btn">End &amp; delete</button>
                                <button id="leaveViewerBtn" class="btn btn-secondary btn-small menu-btn">Leave</button>
                            </div>
                        </div>
                    </details>
                </div>
            </header>

            <!-- Primary Awareness Dock -->
            <section class="viewer-dock" aria-live="polite">
                <div class="dock-row dock-primary" id="primaryStatusLine">Quiet</div>
                <div class="dock-row dock-secondary" id="secondaryAttentionLine">Nothing you need to respond to</div>
                <div class="dock-row dock-chips">
                    <div class="dock-chip dock-chip-coverage">
                        <span class="dock-chip-label">Coverage</span>
                        <span class="dock-chip-value" id="coverageState">Good</span>
                        <span class="dock-chip-reason" id="coverageReason"></span>
                    </div>
                    <div class="dock-chip dock-chip-mode">Viewer</div>
                    <div class="dock-chip dock-chip-degraded" id="degradedChip" style="display:none;">Connection issue — activity only</div>
                </div>
                <div class="dock-row dock-live">
                    <span class="dock-live-label">Now:</span>
                    <span class="dock-live-text" id="liveNowText">Listening…</span>
                    <span class="dock-live-meta" id="liveNowMeta"></span>
                </div>
                <div id="liveNowRow" class="live-now-row-legacy" style="display:none;"></div>
            </section>

            <!-- Scrollable content panel -->
            <main class="viewer-panel">
                <div class="viewer-panel-scroll">
                    <div class="viewer-columns">
                        <div class="viewer-column-main">
                            <div id="topicShiftAlert" class="alert alert-info" style="display: none;">
                                <strong>Topic changed:</strong> <span id="topicShiftText"></span>
                            </div>
                            <div id="onboardingBanner" class="alert alert-info" style="display:none;">
                                <span>Viewer mode is read-only. Your microphone is not used. Live conversation summaries will appear here.</span>
                                <button id="dismissOnboardingBtn" class="btn btn-small btn-link" style="margin-left: 1rem;">Dismiss</button>
                            </div>

                            <section class="card awareness-card viewer-card catchup-card" id="catchUpPanel">
                                <div class="card-header">Catch Up</div>
                                <div class="catchup-actions">
                                    <button id="catchUpBtn" class="btn btn-primary">Catch up</button>
                                </div>
                                <div class="catchup-content">
                                    <p id="missedSummary">Tap Catch up if you missed a moment.</p>
                                    <ul id="missedPoints"></ul>
                                </div>
                                <div class="catchup-meta">
                                    <span class="catchup-confidence">Confidence: cautious</span>
                                    <span class="catchup-degraded" id="catchUpDegraded" style="display:none;">Connection issue — catch up may be limited.</span>
                                </div>
                            </section>

                            <section class="card awareness-card viewer-card">
                                <div class="card-header">What's happening</div>
                                <div class="summary-content-now" id="rollingSummary">Connecting to room...</div>
                                <button class="summary-read-more" id="summaryReadMore" style="display: none;">Read more</button>
                                <div class="summary-updated" id="summaryUpdated"></div>
                            </section>

                            <section class="card awareness-card viewer-card">
                                <div class="card-header">Key points</div>
                                <ul class="key-points-list" id="keyPointsList">
                                    <li class="empty-state">No key points yet. Speak to generate insights.</li>
                                </ul>
                            </section>

                            <section class="card awareness-card viewer-card">
                                <div class="card-header">Decisions / Next steps</div>
                                <div class="decision-block">
                                    <div class="card-subheader">Decisions</div>
                                    <ul class="decisions-list" id="decisionsList">
                                        <li class="empty-state">No decisions detected.</li>
                                    </ul>
                                </div>
                                <div class="decision-block">
                                    <div class="card-subheader">Next steps</div>
                                    <ul class="actions-list" id="actionsList">
                                        <li class="empty-state">No next steps yet.</li>
                                    </ul>
                                    <button id="editActionsBtn" class="btn btn-secondary btn-small" style="display:none; margin-top: 0.75rem;">Edit</button>
                                </div>
                            </section>

                            <section id="readRoomPanel" class="card awareness-card viewer-card read-room-panel" style="display: none;" role="region" aria-labelledby="readRoomPanelTitle">
                                <div class="card-header">
                                    <span id="readRoomPanelTitle">Full Room Overview</span>
                                    <div class="card-header-actions">
                                        <button class="btn btn-secondary btn-small" id="readRoomCopyBtn" aria-label="Copy summary to clipboard">Copy</button>
                                        <button class="btn btn-secondary btn-small" id="readRoomCloseBtn" aria-label="Close Full Room Overview panel">Close</button>
                                    </div>
                                </div>
                                <div class="read-room-content">
                                    <div id="readRoomSegmentNote" class="read-room-segment-note" style="display: none;"></div>
                                    <div class="read-room-summary" id="readRoomSummary" role="region" aria-label="Room overview">Generating full overview...</div>
                                    <div class="read-room-section">
                                        <h3 class="read-room-section-title">Key Points</h3>
                                        <ul class="read-room-points" id="readRoomPoints" aria-label="Key points"></ul>
                                    </div>
                                    <div class="read-room-section" id="readRoomDecisionsSection" style="display: none;">
                                        <h3 class="read-room-section-title">Decisions</h3>
                                        <ul class="read-room-points" id="readRoomDecisions" aria-label="Decisions made"></ul>
                                    </div>
                                    <div class="read-room-section" id="readRoomNextStepsSection" style="display: none;">
                                        <h3 class="read-room-section-title">Next Steps</h3>
                                        <ul class="read-room-points" id="readRoomNextSteps" aria-label="Next steps"></ul>
                                    </div>
                                </div>
                            </section>

                            <details class="debug-panel" id="viewerDebugPanel">
                                <summary>Debug</summary>
                                <div class="debug-content">
                                    <div class="mic-health-block">
                                        <div id="roomListeningState" class="room-listening-state">Connecting to microphones…</div>
                                        <div id="multiMicNote" class="multi-mic-note" style="display:none;">Multiple microphones active — improved coverage</div>
                                        <div id="micNotice" class="mic-notice" style="display:none;"></div>
                                        <div class="mic-health-strip" id="micHealthStrip">
                                            <div class="mic-health-list" id="micHealthList"></div>
                                            <div class="mic-reliability-banner" id="viewerMicBanner" style="display:none;"></div>
                                        </div>
                                    </div>

                                    <div class="card awareness-card topic-log-card" id="topicLogCard">
                                        <div class="card-header topic-log-header">
                                            <span>Topic log</span>
                                            <button class="btn btn-secondary btn-small" id="topicLogToggleBtn" aria-expanded="false">Show</button>
                                        </div>
                                        <div class="topic-log-body" id="topicLogBody" style="display:none;">
                                            <div class="topic-log-empty" id="topicLogEmpty">No topic changes yet.</div>
                                            <div class="topic-log-list" id="topicLogList"></div>
                                        </div>
                                    </div>

                                    <div class="statusbar" id="viewerStatusBar">
                                        <span class="status-item">
                                            <span class="status-dot" id="viewerWsDot"></span>
                                            <span class="status-label">WS</span>
                                            <span class="status-value" id="viewerWsStatus">connecting…</span>
                                        </span>
                                        <span class="status-item">
                                            <span class="status-label">Mics</span>
                                            <span class="status-value" id="viewerMicsStatus">0</span>
                                        </span>
                                        <span class="status-item">
                                            <span class="status-label">Last transcript</span>
                                            <span class="status-value" id="viewerLastTranscript">—</span>
                                        </span>
                                        <span class="status-item status-item-warn" id="viewerWarnItem" style="display:none;">
                                            <span class="status-label">Issue</span>
                                            <span class="status-value" id="viewerWarnText"></span>
                                        </span>
                                    </div>
                                </div>
                            </details>
                        </div>

                        <div class="viewer-column-side">
                            <section class="card awareness-card transcript-card" id="transcriptCard">
                                <div class="card-header transcript-header-collapsible">
                                    <span>Transcript</span>
                                    <div class="transcript-header-actions">
                                        <button id="transcriptToggle" class="btn btn-small btn-secondary" title="Show/hide transcript">Hide</button>
                                        <button id="jumpLiveBtn" class="btn btn-small btn-secondary" style="display:none;">Jump to live</button>
                                    </div>
                                </div>
                                <div class="transcript-content-compact" id="transcriptContent">
                                    <div class="empty-state">Listening…</div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Invite Modal (QR + copy link) -->
    <div id="inviteModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Invite viewers">
        <div class="modal-card card">
            <div class="modal-head">
                <div>
                    <div class="modal-title">Invite Viewers</div>
                    <div class="muted">Scan the QR code to join as a viewer (read-only monitoring).</div>
                </div>
                <button id="inviteClose" class="btn btn-small btn-secondary">Close</button>
            </div>

            <div class="modal-body">
                <div class="field">
                    <div class="label">Viewer invite link (default)</div>
                    <div class="row">
                        <input id="viewerInviteLink" class="input" readonly />
                        <button id="copyViewerLink" class="btn btn-small btn-secondary">Copy</button>
                    </div>
                    <div class="muted" style="margin-top: 8px;">
                        Viewers can monitor the conversation. They can optionally enable microphone to contribute audio.
                    </div>
                </div>

                <div class="field">
                    <div class="label">QR code</div>
                    <div class="qr-wrap card">
                        <img id="viewerQrImg" alt="Viewer invite QR code" />
                    </div>
                    <div class="muted" style="margin-top:8px">
                        Tip: On iPad, scan with the Camera app. Tap the banner to open the link.
                    </div>
                </div>

                <div class="field" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                    <div class="label">Add a speaker mic (optional)</div>
                    <div class="row">
                        <input id="micInviteLink" class="input" readonly />
                        <button id="copyMicLink" class="btn btn-small btn-secondary">Copy</button>
                    </div>
                    <div class="muted" style="margin-top: 8px;">
                        Use this link if you want a device to join as microphone only (no viewer UI).
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Topic Summary Modal -->
    <div id="topicSummaryModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Topic summary">
        <div class="modal-card card">
            <div class="modal-head">
                <div>
                    <div class="modal-title" id="topicSummaryTitle">Topic summary</div>
                    <div class="muted" id="topicSummaryMeta"></div>
                </div>
                <button id="topicSummaryClose" class="btn btn-small btn-secondary">Close</button>
            </div>
            <div class="modal-body">
                <div class="read-room-summary" id="topicSummaryText">Loading…</div>
                <ul class="read-room-points" id="topicSummaryPoints"></ul>
            </div>
        </div>
    </div>

    <script src="/realtime_mic.js"></script>
    <script src="/assets/huddle_loader_particles.js"></script>
    <script src="/app.js"></script>
</body>
</html>
